{{- $storageClassMap := dict
    "openebs-hostpath" "openebs-hostpath"
    "openebs-device" "openebs-device"
    "iscsi" "sys-truenas-iscsi"
    "truenas-nfs" "sys-truenas-nfs"
    "vultr-hdd-retain" "vultr-block-storage-hdd-retain"
    "vultr-hdd" "vultr-block-storage-hdd"
    "vultr" "vultr-block-storage"
    "rook-ceph-block" "rook-ceph-block"
    "csi-s3" "csi-s3"
    "longhorn" "longhorn"
}}
{{- range $item_name, $item := .Values.deployments }}
{{- range $itemVolumes := $item.volumes }}
{{- $volumeType := default "" $itemVolumes.type }}
{{- $hasKnownType := hasKey $storageClassMap $volumeType -}}
{{- $storageClass := "csi-s3" -}}
{{- if $hasKnownType -}}
  {{- $storageClass = index $storageClassMap $volumeType -}}
{{- end -}}
{{- $annotation := "" -}}
{{- if $hasKnownType -}}
  {{- $annotation = $storageClass -}}
{{- end -}}
{{- $requiresFinalizer := or (eq $volumeType "rook-ceph-block") (eq $volumeType "longhorn") -}}
{{- if $hasKnownType }}
---
apiVersion: v1
kind: PersistentVolumeClaim
metadata:
  name: {{ $itemVolumes.name }}
  namespace: {{ $.Release.Namespace }}
  labels:
    app.kubernetes.io/name: {{ $itemVolumes.name }}
  {{- if $annotation }}
  annotations:
    volume.beta.kubernetes.io/storage-class: "{{ $annotation }}"
  {{- end }}
  {{- if $requiresFinalizer }}
  finalizers:
    - kubernetes.io/pvc-protection
  {{- end }}
spec:
  storageClassName: {{ $storageClass }}
  accessModes:
    - ReadWriteOnce
  resources:
    requests:
      storage: {{ if $itemVolumes.size }}{{ $itemVolumes.size }}{{ else }}1Gi{{ end }}
{{- end }}
{{- end }}
{{- end }}
